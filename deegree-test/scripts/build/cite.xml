<?xml version="1.0" encoding="UTF-8"?>
<project name="cite" basedir="../.." xmlns:ivy="antlib:org.apache.ivy.ant">

  <import file="${basedir}/build.xml" optional="false" />

  <property name="cite.dir" value="${basedir}/resources/cite" />
  <property name="tmp.dir" value="${java.io.tmpdir}" />

  <property name="team2.basedir" value="/tmp/cite_testing/team2" />

  <!-- URL where Tomcat archive (configured for port 18080) is loaded from -->
  <property name="test-tomcat.srcurl" value="http://download.deegree.org/test-artefacts/tomcat-6-p18080.tar.gz" />
  <property name="test-tomcat.basedir" value="${tmp.dir}/d3_test_tomcat/" />
  <property name="test-tomcat.archive" value="${tmp.dir}/tomcat-6-p18080.tar.gz" />

	<target name="build-sos-100" description="Create webapp for running CITE SOS 1.0.0 tests">
	        <property name="webapp.name" value="cite-sos-100" />
	        <property name="webapp.src" value="${basedir}/resources/cite/sos-1.0.0/webapp" />
	        <antcall target="init-webapp" />
	</target>
	
  <target name="build-wfs-100" description="Create webapp for running CITE WFS 1.0.0 tests">
    <property name="webapp.name" value="cite-wfs-100" />
    <property name="webapp.src" value="${basedir}/resources/cite/wfs-1.0.0/webapp" />
    <antcall target="init-webapp" />
  </target>

  <target name="build-wfs-110" description="Create webapp for running CITE WFS 1.1.0 tests">
    <property name="webapp.name" value="cite-wfs-110" />
    <property name="webapp.src" value="${basedir}/resources/cite/wfs-1.1.0/webapp" />
    <antcall target="init-webapp" />
  </target>

  <target name="build-wms-130" description="Create webapp for running CITE WMS 1.3.0 tests">
    <property name="webapp.name" value="cite-wms-130" />
    <property name="webapp.src" value="${basedir}/resources/cite/wms-1.3.0/webapp" />
    <antcall target="init-webapp" />
  </target>
  
  <target name="build-wms-130-new" description="Create webapp for running new CITE WMS 1.3.0 tests">
    <property name="webapp.name" value="cite-wms-130" />
    <property name="webapp.src" value="${basedir}/resources/cite/wms-1.3.0/webapp" />
    <antcall target="init-webapp" />
  </target>
  
  <target name="build-wms-111" description="Create webapp for running CITE WMS 1.1.1 tests">
     <property name="webapp.name" value="cite-wms-111" />
     <property name="webapp.src" value="${basedir}/resources/cite/wms-1.1.1/webapp" />
     <antcall target="init-webapp" />
  </target>

  <target name="build-wcs-100" description="Create webapp for running CITE WCS 1.0.0 tests">
    <property name="webapp.name" value="cite-wcs-100" />
    <property name="webapp.src" value="${basedir}/resources/cite/wcs-1.0.0/webapp" />
    <antcall target="init-webapp" />
  </target>

  <target name="run-tests" description="Run all CITE tests">
    <antcall target="run-wfs-100" />
    <antcall target="run-wfs-110" />
    <antcall target="run-wms-130" />
    <antcall target="run-wms-130-new" />
    <antcall target="run-wms-111" />
	<antcall target="run-sos-100" />    
    <antcall target="run-wcs-100" />

    <junitreport todir="${build.dir}">
      <fileset dir="${build.dir}">
        <include name="TEST-*.xml" />
      </fileset>
      <report format="frames" todir="${build.dir}/html" />
    </junitreport>
  </target>

	<target name="run-sos-100" description="Create webapp for running CITE SOS 1.0.0 tests and run test suite" depends="build-sos-100,compile">

	    <property name="suite.dir" value="sos100" />
	    <antcall target="setup-tomcat" />
	    <antcall target="start-tomcat" />

	    <echo message="Invoking CITE SOS 1.0.0 test suite" />
	    <junit maxmemory="1024m" fork="yes" haltonfailure="no" haltonerror="no">
	    	<jvmarg line="-Xmx2048m -Xss256m -XX:-UseGCOverheadLimit -Xincgc "/>
	        <classpath>
	            <pathelement location="${basedir}/resources/cite/lib" />
	            <fileset dir="${basedir}/resources/cite/lib">
	                <include name="*.jar" />
	            </fileset>
	            <pathelement location="${cite.dir}/sos-1.0.0/cite/resources" />
	            <pathelement path="${classes.dir}" />
	            <path refid="build.path" />
	        </classpath>
	        <sysproperty key="cite.script" value="${cite.dir}/sos-1.0.0/cite/ctl/" />
	        <formatter type="xml" />
	        <test name="org.deegree.test.cite.CiteSOS100TestSuite" todir="${build.dir}" />
	    </junit>

	    <junitreport todir="${build.dir}">
	        <fileset dir="${build.dir}">
	            <include name="TEST-*.xml" />
	        </fileset>
	        <report format="frames" todir="${build.dir}/html" />
	    </junitreport>

	    <antcall target="stop-tomcat" />
	</target>
	
	<target name="run-wfs-100" description="Create webapp for running CITE WFS 1.0.0 tests and run test suite" depends="build-wfs-100,compile">

		<property name="suite.dir" value="wfs100" />
		<antcall target="setup-tomcat" />
		<antcall target="start-tomcat" />

		<delete dir="${cite.dir}/wfs-1.0.0/cite/" />
		<mkdir dir="${cite.dir}/wfs-1.0.0/cite" />
		<get src="http://portal.opengeospatial.org/files/index.php?artifact_id=21115" dest="${cite.dir}/wfs-1.0.0/ets.zip" />
		<unzip src="${cite.dir}/wfs-1.0.0/ets.zip" dest="${cite.dir}/wfs-1.0.0/cite/" />
		<patch patchfile="${cite.dir}/wfs-1.0.0/patch" dir="${cite.dir}/wfs-1.0.0/cite/scripts/wfs-1.0.0/ctl" />

		<echo message="Invoking CITE WFS 1.0.0 test suite" />
		<junit maxmemory="1024m" fork="yes" haltonfailure="no" haltonerror="no">
			<classpath>
				<pathelement location="${basedir}/resources/cite/lib" />
				<fileset dir="${basedir}/resources/cite/lib">
					<include name="*.jar" />
				</fileset>
				<pathelement location="${cite.dir}/wfs-1.0.0/cite/resources" />
				<pathelement path="${classes.dir}" />
				<path refid="build.path" />
			</classpath>
			<sysproperty key="cite.script" value="${cite.dir}/wfs-1.0.0/cite/scripts/wfs-1.0.0/ctl/wfs.xml" />
			<formatter type="xml" />
			<test name="org.deegree.test.cite.CiteWFS100TestSuite" todir="${build.dir}" />
		</junit>

		<junitreport todir="${build.dir}">
			<fileset dir="${build.dir}">
				<include name="TEST-*.xml" />
			</fileset>
			<report format="frames" todir="${build.dir}/html" />
		</junitreport>

		<antcall target="stop-tomcat" />
	</target>

  <target name="run-wfs-110" description="Create webapp for running CITE WFS 1.1.0 tests and run test suite" depends="build-wfs-110,compile">

    <property name="suite.dir" value="wfs110" />
    <antcall target="setup-tomcat" />
    <antcall target="start-tomcat" />

    <echo message="Invoking CITE WFS 1.1.0 test suite" />
    <junit maxmemory="1024m" fork="yes" haltonfailure="no" haltonerror="no">
      <classpath>
        <pathelement location="${basedir}/resources/cite/lib" />
        <fileset dir="${basedir}/resources/cite/lib">
          <include name="*.jar" />
        </fileset>
        <pathelement location="${cite.dir}/wfs-1.1.0/cite/resources" />
        <pathelement path="${classes.dir}" />
        <path refid="build.path" />
      </classpath>
      <sysproperty key="cite.script" value="${cite.dir}/wfs-1.1.0/cite/src/main.xml" />
      <formatter type="xml" />
      <test name="org.deegree.test.cite.CiteWFS110TestSuite" todir="${build.dir}" />
    </junit>

    <junitreport todir="${build.dir}">
      <fileset dir="${build.dir}">
        <include name="TEST-*.xml" />
      </fileset>
      <report format="frames" todir="${build.dir}/html" />
    </junitreport>

    <antcall target="stop-tomcat" />
  </target>

  <target name="run-wms-130" description="Create webapp for running CITE WMS 1.3.0 tests and run test suite" depends="build-wms-130,compile">

    <property name="suite.dir" value="wms130" />
    <antcall target="setup-tomcat" />
    <antcall target="start-tomcat" />

    <delete dir="${cite.dir}/wms-1.3.0/cite/" />
    <mkdir dir="${cite.dir}/wms-1.3.0/cite" />
    <get src="http://portal.opengeospatial.org/files/index.php?artifact_id=21120" dest="${cite.dir}/wms-1.3.0/ets.zip" />
    <unzip src="${cite.dir}/wms-1.3.0/ets.zip" dest="${cite.dir}/wms-1.3.0/cite/" />
    <patch patchfile="${cite.dir}/wms-1.3.0/patch" dir="${cite.dir}/wms-1.3.0/cite/scripts/wms-1.3.0/ctl" />

    <echo message="Invoking CITE WMS 1.3.0 test suite" />
    <junit maxmemory="1024m" fork="yes" haltonfailure="no" haltonerror="no">
      <classpath>
        <pathelement location="${basedir}/resources/cite/lib" />
        <fileset dir="${basedir}/resources/cite/lib">
          <include name="*.jar" />
        </fileset>
        <pathelement location="${cite.dir}/wms-1.3.0/cite/resources" />
        <pathelement path="${classes.dir}" />
        <path refid="build.path" />
      </classpath>
      <sysproperty key="cite.script" value="${cite.dir}/wms-1.3.0/cite/scripts/wms-1.3.0/ctl/" />
      <formatter type="xml" />
      <test name="org.deegree.test.cite.CiteWMS130TestSuite" todir="${build.dir}" />
    </junit>

    <junitreport todir="${build.dir}">
      <fileset dir="${build.dir}">
        <include name="TEST-*.xml" />
      </fileset>
      <report format="frames" todir="${build.dir}/html" />
    </junitreport>

    <antcall target="stop-tomcat" />
  </target>

  <target name="run-wms-130-new" description="Create webapp for running new CITE WMS 1.3.0 tests and run test suite" depends="build-wms-130,compile">

    <property name="suite.dir" value="wms130" />
    <antcall target="setup-tomcat" />
    <antcall target="start-tomcat" />

    <echo message="Invoking new CITE WMS 1.3.0 test suite" />
    <junit maxmemory="1024m" fork="yes" haltonfailure="no" haltonerror="no">
      <classpath>
        <pathelement location="${basedir}/resources/cite/lib" />
        <fileset dir="${basedir}/resources/cite/lib">
          <include name="*.jar" />
        </fileset>
        <pathelement location="${cite.dir}/wms-1.3.0-new/cite/resources" />
        <pathelement path="${classes.dir}" />
        <path refid="build.path" />
      </classpath>
      <sysproperty key="cite.script" value="${cite.dir}/wms-1.3.0-new/cite/scripts/wms-1.3.0-new/ctl/" />
      <formatter type="xml" />
      <test name="org.deegree.test.cite.NewCiteWMS130TestSuite" todir="${build.dir}" />
    </junit>

    <junitreport todir="${build.dir}">
      <fileset dir="${build.dir}">
        <include name="TEST-*.xml" />
      </fileset>
      <report format="frames" todir="${build.dir}/html" />
    </junitreport>

    <antcall target="stop-tomcat" />
  </target>
  
      <target name="run-wms-111" description="Create webapp for running CITE WMS 1.1.1 tests and run test suite" depends="build-wms-111,compile">

        <property name="suite.dir" value="wms111" />
        <antcall target="setup-tomcat" />
        <antcall target="start-tomcat" />

	<delete dir="${cite.dir}/wms-1.1.1/cite/" />
	<mkdir dir="${cite.dir}/wms-1.1.1/cite" />
	<get src="http://portal.opengeospatial.org/files/index.php?artifact_id=21118" dest="${cite.dir}/wms-1.1.1/ets.zip" />
	<unzip src="${cite.dir}/wms-1.1.1/ets.zip" dest="${cite.dir}/wms-1.1.1/cite/" />
	<patch patchfile="${cite.dir}/wms-1.1.1/patch" dir="${cite.dir}/wms-1.1.1/cite/scripts/wms-1.1.1/ctl" />

        <echo message="Invoking CITE WMS 1.1.1 test suite" />
        <junit maxmemory="1024m" fork="yes" haltonfailure="no" haltonerror="no">
            <classpath>
                <pathelement location="${basedir}/resources/cite/lib" />
                <fileset dir="${basedir}/resources/cite/lib">
                    <include name="*.jar" />
                </fileset>
                <pathelement location="${cite.dir}/wms-1.1.1/cite/resources" />
                <pathelement path="${classes.dir}" />
                <path refid="build.path" />
            </classpath>
            <sysproperty key="cite.script" value="${cite.dir}/wms-1.1.1/cite/scripts/wms-1.1.1/ctl/" />
            <formatter type="xml" />
            <test name="org.deegree.test.cite.CiteWMS111TestSuite" todir="${build.dir}" />
        </junit>

        <junitreport todir="${build.dir}">
            <fileset dir="${build.dir}">
                <include name="TEST-*.xml" />
            </fileset>
            <report format="frames" todir="${build.dir}/html" />
        </junitreport>

        <antcall target="stop-tomcat" />
    </target>

  <target name="run-wcs-100" description="Create webapp for running CITE WCS 1.0.0 tests and run test suite" depends="build-wcs-100,compile">

    <property name="suite.dir" value="wcs100" />
    <antcall target="setup-tomcat" />
    <antcall target="start-tomcat" />

    <echo message="Invoking CITE WCS 1.0.0 test suite" />
    <junit maxmemory="1024m" fork="yes" haltonfailure="no" haltonerror="no">
      <classpath>
        <pathelement location="${basedir}/resources/cite/lib" />
        <fileset dir="${basedir}/resources/cite/lib">
          <include name="*.jar" />
        </fileset>
        <pathelement location="${cite.dir}/wcs-1.0.0/cite/resources" />
        <pathelement path="${classes.dir}" />
        <path refid="build.path" />
      </classpath>
      <sysproperty key="cite.script" value="${cite.dir}/wcs-1.0.0/cite/ctl/wcs.xml" />
      <formatter type="xml" />
      <test name="org.deegree.test.cite.CiteWCS100TestSuite" todir="${build.dir}" />
    </junit>

    <junitreport todir="${build.dir}">
      <fileset dir="${build.dir}">
        <include name="TEST-*.xml" />
      </fileset>
      <report format="frames" todir="${build.dir}/html" />
    </junitreport>

    <antcall target="stop-tomcat" />
  </target>


  <target name="setup-tomcat" depends="retrieve-tomcat">
    <delete dir="${test-tomcat.basedir}" failonerror="false" />
    <untar src="${test-tomcat.archive}" dest="${test-tomcat.basedir}" compression="gzip" />
    <copy todir="${test-tomcat.basedir}/webapps/${webapp.name}">
      <fileset dir="${build.dir}/${webapp.name}" defaultexcludes="true">
        <include name="**" />
      </fileset>
    </copy>
  </target>

  <target name="start-tomcat">
    <java jar="${test-tomcat.basedir}/bin/bootstrap.jar" spawn="true" fork="true">
      <jvmarg value="-Dcatalina.home=${test-tomcat.basedir}" />
    </java>
    <sleep seconds="10" />
  </target>

  <target name="check-for-tomcat">
    <echo message="Checking if Tomcat started up" />
    <get src="http://127.0.0.1:18080" dest="/tmp/tomcat" />
  </target>

  <target name="stop-tomcat">
    <java jar="${test-tomcat.basedir}/bin/bootstrap.jar" fork="true">
      <jvmarg value="-Dcatalina.home=${test-tomcat.basedir}" />
      <arg line="stop" />
    </java>
  </target>

  <target name="init-webapp" depends="load-ivy">

    <property name="webapp.dir" value="${build.dir}/${webapp.name}" />

    <!-- copy webapp skeleton -->
    <delete dir="${webapp.dir}" failonerror="false" />
    <mkdir dir="${webapp.dir}" />
    <copy todir="${webapp.dir}">
      <fileset dir="${webapp.src}" defaultexcludes="true">
        <include name="**" />
      </fileset>
    </copy>

    <!-- added needed libraries -->
    <ivy:retrieve pattern="${webapp.dir}/WEB-INF/lib/[artifact](-[revision]).[ext]" file="${ivy.dependencies.file}" log="${ivy.resolve.verbose}" sync="true" />
  </target>

  <!-- Retrieve archive that contains pre-configured Tomcat 6 (port 18080) -->
  <target name="retrieve-tomcat">
    <get src="${test-tomcat.srcurl}" dest="${test-tomcat.archive}" usetimestamp="true" />
  </target>

</project>
